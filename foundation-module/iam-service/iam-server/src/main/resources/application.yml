# Synapse 配置
synapse:
  databases:
    # 使用SQL注解功能（推荐）
    sql-annotation:
      enabled: true
    # 禁用auto-repository避免冲突
    auto-repository:
      enabled: false
  datasource:
    mybatis-plus:
      configuration:
        log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
        map-underscore-to-camel-case: true
      global-config:
        banner: false
    primary: master1
    # 字段转换配置
    field-conversion:
      enabled: true
      strategy: CAMEL_TO_UNDERLINE
    failover:
      enabled: true
      strategy: HEALTHY_FIRST  # 主数据源优先
      max-retry-times: 3
      retry-interval: 1000
      detection-interval: 5000
      recovery-interval: 10000
    # 数据源配置
    datasources:
      master1:
        type: MYSQL
        host: 10.80.3.24
        port: 6450
        database: synapse_iam
        username: xmom
        password: 123456
        pool-type: HIKARI
        weight: 100       # 权重
        params:
          useUnicode: "true"
          characterEncoding: "utf8"
          useSSL: "false"
          allowPublicKeyRetrieval: "true"
          serverTimezone: "Asia/Shanghai"
          autoReconnect: "true"
          failOverReadOnly: "false"
          maxReconnects: "3"
          initialTimeout: "2"
        hikari:
          minimum-idle: 5
          maximum-pool-size: 15
          idle-timeout: 30000
          max-lifetime: 1800000
          connection-timeout: 30000
          # 添加连接验证
          connection-test-query: "SELECT 1"
          validation-timeout: 5000
      master2:
        type: MYSQL
        host: 10.80.3.25
        port: 6450
        database: synapse_iam
        username: xmom
        password: 123456
        pool-type: HIKARI
        weight: 100       # 权重
        params:
          useUnicode: "true"
          characterEncoding: "utf8"
          useSSL: "false"
          allowPublicKeyRetrieval: "true"
          serverTimezone: "Asia/Shanghai"
          autoReconnect: "true"
          failOverReadOnly: "false"
          maxReconnects: "3"
          initialTimeout: "2"
        hikari:
          minimum-idle: 5
          maximum-pool-size: 15
          idle-timeout: 30000
          max-lifetime: 1800000
          connection-timeout: 30000
          # 添加连接验证
          connection-test-query: "SELECT 1"
          validation-timeout: 5000
    seata:
      enabled: false
  security:
    # 是否启用安全模块
    enabled: true
    # 安全模式：STRICT（严格模式，所有请求都需要认证）、PERMISSIVE（宽松模式，部分请求可以匿名访问）、DISABLED（关闭模式，不进行安全控制）
    mode: PERMISSIVE
    # 白名单配置
    white-list:
      # 是否启用白名单
      enabled: true
      # 白名单路径列表（支持 Ant 风格路径匹配）
      paths:
        - "/api/iam/auth/**"  # IAM 认证接口
        - "/api/public/**"     # 公开接口
    # Token 配置
    token:
      # Token 前缀（用于 Authorization 请求头）
      prefix: "Bearer "
      # Token 查询参数名
      query-param: "token"
      # Authorization 请求头名称
      header-name: "Authorization"
      # X-Auth-Token 请求头名称（备用 token 传递方式）
      x-auth-token-header: "X-Auth-Token"
    # Gateway 签名配置（用于 Gateway 和微服务之间的签名验证）
    gateway-signature:
      # 是否启用 Gateway 签名验证
      enabled: true
      # Gateway 签名密钥（生产环境必须修改为强密钥）
      secret: "synapse-gateway-secret-key-change-in-production"
      # 签名有效期窗口（毫秒），默认 5 分钟，防止重放攻击
      validity-window: 300000
      # 是否启用用户上下文传递（启用后，Gateway 会将用户上下文编码到请求头，减少微服务的 Redis 查询）
      enable-context-passing: true
    # 内部服务调用配置（用于服务间调用的签名验证）
    internal-service:
      # 是否启用内部服务调用签名验证
      enabled: true
      # 当前服务名称（用于标识调用来源）
      service-name: "iam-service"
      # 当前服务密钥（用于生成签名，生产环境必须修改为强密钥）
      secret: "iam-service-secret-key-change-in-production"
      # 签名有效期窗口（毫秒），默认 5 分钟，防止重放攻击
      validity-window: 300000
      # 允许调用的服务白名单（key: 服务名称, value: 服务密钥）
      # 如果需要配置，取消注释并填写服务名称和密钥
      # allowed-services:
      #   gateway-service: "gateway-service-secret-key"
      #   mdm-service: "mdm-service-secret-key"
  cache:
    enabled: true
    default-strategy: "LOCAL_AND_REDIS"
    redis-cache:
      # 连接配置（哨兵模式也需要，用于设置 database 和主节点密码）
      connection:
        database: 0  # 数据库索引，默认 0
        password:    # 主节点密码（如果有）
      sentinel:
        enabled: true
        master: mymaster
        nodes:
          - 10.80.3.21:26379
          - 10.80.3.22:26379
          - 10.80.3.23:26379
          - 10.80.3.24:26379
          - 10.80.3.25:26379
        password:    # 哨兵密码（如果有，与主节点密码可能不同）
      connection-timeout: PT5S
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0
        max-wait: PT-1S
      enabled: true
  events:
    enabled: false

# 日志配置
logging:
  level:
    root: INFO
#    com.indigo: INFO
    com.indigo.databases: INFO
#    com.indigo.security: INFO


#mybatis-plus:
#  configuration:
#    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
#    map-underscore-to-camel-case: true
#  ## 管理端点
#  global-config:
#    banner: false